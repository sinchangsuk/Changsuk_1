<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Tap Anywhere to Play (m4a, accessible)</title>
<style>
  :root{
    --BODY_BG_URL: ""; /* 예: url('cover.jpg') */
  }

  html,body{height:100%;margin:0}
  body{
    /* 재생 전에도 보이지만 오버레이가 덮고 있음 */
    background:
      radial-gradient(120% 120% at 10% 0%, #1b1f3a, transparent 60%),
      radial-gradient(120% 120% at 90% 100%, #2b4a7c, transparent 60%),
      linear-gradient(160deg, #0f1020, #0b0c19);
    background-attachment: fixed;
  }
  /* 배경 이미지가 있으면 그라데이션 위에 얹기 */
  body.playing{
    background-image:
      var(--BODY_BG_URL),
      radial-gradient(120% 120% at 10% 0%, #1b1f3a, transparent 60%),
      radial-gradient(120% 120% at 90% 100%, #2b4a7c, transparent 60%),
      linear-gradient(160deg, #0f1020, #0b0c19);
    background-size:
      cover, auto, auto, auto;
    background-position:
      center center, center, center, center;
    background-repeat:
      no-repeat, no-repeat, no-repeat, no-repeat;
  }

  /* 과도한 움직임 줄이기: 사용자 선호 존중 */
  @media (prefers-reduced-motion: no-preference){
    body.playing{
      animation: hueShift 18s linear infinite;
    }
    @keyframes hueShift{
      0%{ filter: hue-rotate(0deg) }
      100%{ filter: hue-rotate(15deg) }
    }
  }

  /* 오버레이: 심플+큰 글자 */
  #overlay{
    position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
    background:rgba(0,0,0,.72); color:#fff; text-align:center; cursor:pointer; user-select:none;
    padding:24px;
  }
  /* 중장년층 가독성: 큰 글자 + 굵게 + 행간 */
  #overlayText{
    font: 700 clamp(22px, 6vw, 40px) / 1.35 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    letter-spacing: 0.2px;
  }

  /* 재생 중 표시 배지 */
  #playingBadge{
    position: fixed; left: 50%; bottom: 18px; transform: translateX(-50%);
    display: flex; align-items: center; gap: 8px;
    padding: 10px 14px; border-radius: 999px;
    background: rgba(0,0,0,.55); color: #fff;
    font: 600 14px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    backdrop-filter: blur(6px);
    opacity: 0; pointer-events: none; transition: opacity .35s ease;
  }
  body.playing #playingBadge{ opacity: 1 }

  .dot{
    width:10px; height:10px; border-radius:50%;
    background:#7cffb2;
    box-shadow: 0 0 10px #7cffb2;
  }
  @media (prefers-reduced-motion: no-preference){
    .dot{ animation: pulse 1.4s ease-in-out infinite }
    @keyframes pulse{
      0%,100%{ transform: scale(1); opacity: .9 }
      50%{ transform: scale(1.25); opacity: 1 }
    }
  }
</style>
</head>
<body>
  <!-- 재생 전 안내(심플/큰 글자) -->
  <div id="overlay">
    <div id="overlayText">화면 아무 곳이나 터치하면 재생됩니다</div>
  </div>

  <!-- 재생 중 배지 -->
  <div id="playingBadge" aria-live="polite" aria-atomic="true">
    <span class="dot" aria-hidden="true"></span>
    <span>재생 중</span>
  </div>

<script>
(function(){
  const FILE_URL = "test.m4a"; // 같은 폴더 기준

  let started = false;
  function bindOnce(){
    document.addEventListener('touchend', onGesture, { once:true, passive:false });
    document.addEventListener('click',    onGesture, { once:true });
    document.addEventListener('mouseup',  onGesture, { once:true });
  }

  async function onGesture(){
    if (started) return; started = true;
    try {
      const AC = window.AudioContext || window.webkitAudioContext;
      if (!AC) throw new Error('AudioContext unsupported');
      const ctx = new AC();
      if (ctx.state === 'suspended') { await ctx.resume(); }

      // 무음 오실레이터로 오디오 경로 언락
      const osc = ctx.createOscillator();
      const gain = ctx.createGain(); gain.gain.value = 0.00001;
      osc.connect(gain).connect(ctx.destination); osc.start();
      setTimeout(()=>{ try{osc.stop();}catch(_){} }, 30);

      const a = new Audio();
      a.setAttribute('playsinline','');
      a.preload = 'auto';
      a.src = FILE_URL;
      a.crossOrigin = 'anonymous';
      a.volume = 1.0;

      const source = ctx.createMediaElementSource(a);
      source.connect(ctx.destination);
      a.load();

      let playPromise;
      try {
        playPromise = a.play();
      } catch(eImmediate){
        return fallbackDecode(ctx);
      }

      if (playPromise && typeof playPromise.then === 'function') {
        let settled = false;
        const onOK = ()=>{ settled = true; onSuccess(a); };
        playPromise.then(onOK).catch(()=>fallbackDecode(ctx));

        const timer = setTimeout(()=>{ if (!settled && a.paused) fallbackDecode(ctx); }, 1200);
        a.addEventListener('playing', ()=>{ clearTimeout(timer); onOK(); }, { once:true });
      } else {
        const t = setTimeout(()=>{ if (a.paused) fallbackDecode(ctx); }, 1200);
        a.addEventListener('playing', ()=>{ clearTimeout(t); onSuccess(a); }, { once:true });
      }

      function onSuccess(audioEl){
        document.body.classList.add('playing');
        const ov = document.getElementById('overlay');
        if (ov) ov.style.display = 'none';

        document.addEventListener('visibilitychange', ()=>{
          if (!document.hidden && audioEl.paused) { audioEl.play().catch(()=>{}); }
        });
      }

      async function fallbackDecode(ctxInstance){
        try {
          const resp = await fetch(FILE_URL, { cache: 'force-cache' });
          if (!resp.ok) throw new Error('HTTP '+resp.status);
          const arr = await resp.arrayBuffer();
          const buf = await new Promise((res, rej)=> {
            try { ctxInstance.decodeAudioData(arr, res, rej); } catch(e){ rej(e); }
          });
          const node = ctxInstance.createBufferSource();
          node.buffer = buf;
          node.connect(ctxInstance.destination);
          node.start(0);

          document.body.classList.add('playing');
          const ov = document.getElementById('overlay');
          if (ov) ov.style.display = 'none';
        } catch(e) {
          // 실패 시 다시 시도 가능하도록
          const ov = document.getElementById('overlay');
          if (ov) ov.style.display = 'flex';
          started = false;
          bindOnce();
        }
      }

    } catch(eOuter){
      // 브라우저/OS 제한
      started = false;
      bindOnce();
    }
  }

  bindOnce();
})();
</script>
</body>
</html>
