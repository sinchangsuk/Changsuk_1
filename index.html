<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Tap Anywhere to Play (m4a)</title>
<style>
  #tap{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
  background:rgba(0,0,0,.6);color:#fff;font:16px/1.5 system-ui,-apple-system,Roboto,Arial,sans-serif}
</style>

<div id="tap">화면을 터치하면 재생됩니다</div>

<script>
(function(){
  const URL_M4A = "https://sinchangsuk.github.io/Changsuk_1/test.m4a";

  let started = false;
  async function start(){
    if (started) return; started = true;

    // ① 제스처 안에서 "그때" 생성 + src 세팅
    const a = new Audio();
    a.preload = "auto";
    a.playsInline = true;  // iOS
    a.src = URL_M4A;       // 여기서 세팅해야 제스처 맥락 유지 확률↑
    a.volume = 1.0;

    try {
      // ② 바로 play() (동기 맥락)
      await a.play();
      document.getElementById('tap').style.display = 'none';

      // ③ 백그라운드 복귀시 끊기면 재시도
      document.addEventListener('visibilitychange', () => {
        if (!document.hidden && a.paused) a.play().catch(()=>{});
      });

    } catch (e) {
      console.log('HTMLAudio failed:', e);
      // 실패시 WebAudio 백업으로 전환
      startWebAudio();
    }

    remove();
  }

  function remove(){
    document.removeEventListener('pointerdown', start, {once:true});
    document.removeEventListener('touchend', start, {once:true});
    document.removeEventListener('click', start, {once:true});
  }

  document.addEventListener('pointerdown', start, { once:true, passive:true });
  document.addEventListener('touchend',    start, { once:true, passive:true });
  document.addEventListener('click',       start, { once:true });

  // ---- WebAudio 백업 ----
  function startWebAudio(){
    const AC = window.AudioContext || window.webkitAudioContext;
    if (!AC) return; // 구형 브라우저
    const ctx = new AC();

    const tryStart = async () => {
      try { if (ctx.state === 'suspended') await ctx.resume(); } catch(_){}
      try {
        const resp = await fetch(URL_M4A, { cache: 'force-cache' }); // 동일 출처
        if (!resp.ok) throw new Error('HTTP '+resp.status);
        const arr = await resp.arrayBuffer();
        const buf = await new Promise((res, rej)=> ctx.decodeAudioData(arr, res, rej));
        const src = ctx.createBufferSource();
        src.buffer = buf;
        src.connect(ctx.destination);
        src.start(0);
        document.getElementById('tap').style.display = 'none';
      } catch(err){
        console.log('WebAudio failed:', err);
        // 여전히 실패면 사용자에게 볼륨/무음/코덱 메시지
        const t = document.getElementById('tap');
        t.textContent = '재생 실패: iOS 무음 스위치/볼륨 또는 파일 코덱(AAC-LC) 확인 후 다시 터치';
        started = false; // 재시도 허용
      }
    };
    tryStart();
  }
})();
</script>
