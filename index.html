<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Tap Anywhere to Play (m4a, hardened)</title>
<style>
  html,body{height:100%;margin:0}
  #overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
    background:rgba(0,0,0,.7);color:#fff;font:16px/1.5 system-ui,-apple-system,Roboto,Arial,sans-serif;
    text-align:center;padding:24px;cursor:pointer;user-select:none}
  #hint{opacity:.8;font-size:13px;margin-top:6px}
</style>
</head>
<body>
  <div id="overlay">
    í™”ë©´ ì•„ë¬´ ê³³ì´ë‚˜ í•œ ë²ˆë§Œ í„°ì¹˜í•˜ë©´ ì¬ìƒë©ë‹ˆë‹¤ ğŸµ
    <div id="hint">(iPhone: ë¬´ìŒ ìŠ¤ìœ„ì¹˜/ë³¼ë¥¨/ì‚¬ì´íŠ¸ ìŒì†Œê±° í™•ì¸)</div>
  </div>

<script>
(function(){
  const FILE_URL = "test.m4a"; // ê°™ì€ í´ë” ê¸°ì¤€ (ë™ì¼ ì¶œì²˜ ìœ ì§€)

  // ---- 0) ìš”ì†Œ/ì»¨í…ìŠ¤íŠ¸ ì¤€ë¹„ (ì „ì—­ ìƒì„± X, ì œìŠ¤ì²˜ ì•ˆì—ì„œ ìƒì„±í•  ê²ƒë“¤ë§Œ ë‚¨ê²¨ë‘ )
  let started = false;

  // ---- 1) ì œìŠ¤ì²˜ í•¸ë“¤ëŸ¬: iOSì—ì„œ ê°€ì¥ ì•ˆì •ì ì¸ 'touchend' ìš°ì„ 
  function bindOnce(){
    // passive:false ë¡œ ë‘¬ì•¼ iOSê°€ 'ì‚¬ìš©ì í™œì„±í™”'ë¡œ íŒì •í•˜ëŠ” ì¼€ì´ìŠ¤ê°€ ìˆìŒ
    document.addEventListener('touchend', onGesture, { once:true, passive:false });
    document.addEventListener('click',    onGesture, { once:true });
    // ì¼ë¶€ ì•ˆë“œë¡œì´ë“œ/ë°ìŠ¤í¬íƒ‘ ëŒ€ë¹„
    document.addEventListener('mouseup',  onGesture, { once:true });
  }

  async function onGesture(ev){
    if (started) return; started = true;
    try {
      // ---- 2) Web Audio ì–¸ë½ (ê°€ì²­ ê²½ë¡œ ì—´ê¸°)
      const AC = window.AudioContext || window.webkitAudioContext;
      if (!AC) throw new Error('AudioContext unsupported');
      const ctx = new AC();

      // ì‚¬ìš©ì ì œìŠ¤ì²˜ ì•ˆì—ì„œ ì¦‰ì‹œ resume
      if (ctx.state === 'suspended') { await ctx.resume(); }

      // ì´ˆë‹¨ê¸° ë¬´ìŒ ì˜¤ì‹¤ë ˆì´í„°ë¡œ ì˜¤ë””ì˜¤ ê²½ë¡œë¥¼ 'ì‹¤ì œë¡œ' ìš¸ë ¤ì¤Œ (ì¼ë¶€ ê¸°ê¸° í•„ìš”)
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      gain.gain.value = 0.00001; // ì‚¬ì‹¤ìƒ ë¬´ìŒ
      osc.connect(gain).connect(ctx.destination);
      osc.start();
      // 30ms í›„ ì •ì§€ (ë™ê¸° ì²´ì¸ ìœ ì§€)
      setTimeout(()=>{ try{osc.stop();}catch(_){ } }, 30);

      // ---- 3) HTMLAudioë¥¼ ì œìŠ¤ì²˜ ì•ˆì—ì„œ ë™ì  ìƒì„± + ì¦‰ì‹œ play
      const a = new Audio();
      a.setAttribute('playsinline','');
      a.preload = 'auto';
      a.src = FILE_URL;   // ì œìŠ¤ì²˜ ì‹œì ì— src ì§€ì •
      a.crossOrigin = 'anonymous'; // same-originì´ì§€ë§Œ MediaElementSource í˜¸í™˜ì„ ìœ„í•´
      a.volume = 1.0;

      // MediaElementSourceë¡œ ê²½ìœ  â†’ ì¼ë¶€ ì •ì±…/ë””ë°”ì´ìŠ¤ì—ì„œ ì„±ê³µë¥ â†‘
      const source = ctx.createMediaElementSource(a);
      source.connect(ctx.destination);

      // iOSê°€ ì²« í”„ë ˆì„ ë¡œë”© ì¤‘ play ê±°ë¶€í•˜ëŠ” ì¼€ì´ìŠ¤ ë°©ì§€: load í›„ ì¦‰ì‹œ ì‹œë„
      a.load();

      // ë™ê¸° ì»¨í…ìŠ¤íŠ¸ì—ì„œ ë°”ë¡œ í˜¸ì¶œ (awaitë¡œ ì§€ì—° ë§Œë“¤ì§€ ì•ŠìŒ)
      let playPromise;
      try {
        playPromise = a.play();
      } catch(eImmediate){
        // play()ê°€ ì¦‰ì‹œ ì˜ˆì™¸ë©´ ê³§ë°”ë¡œ WebAudio decode í´ë°±
        return fallbackDecode(ctx);
      }

      // ì¼ë¶€ ë¸Œë¼ìš°ì €ëŠ” Promise ë°˜í™˜ â†’ ë™ê¸° íë¦„ ìœ ì§€í•˜ë©´ì„œ ì²˜ë¦¬
      if (playPromise && typeof playPromise.then === 'function') {
        let settled = false;
        playPromise.then(()=>{ settled = true; onSuccess(); })
                   .catch(async (_)=>{ await fallbackDecode(ctx); });

        // 1200ms ë‚´ playing ì´ë²¤íŠ¸ê°€ ì•ˆ ì˜¤ë©´ í´ë°± ì‹œë„
        const timer = setTimeout(async ()=>{
          if (!settled && a.paused) { await fallbackDecode(ctx); }
        }, 1200);

        a.addEventListener('playing', ()=>{ clearTimeout(timer); onSuccess(); }, { once:true });
      } else {
        // Promise ë¯¸ì§€ì› ë¸Œë¼ìš°ì €: playing ì´ë²¤íŠ¸ë¡œ íŒë‹¨
        const t = setTimeout(async ()=>{ if (a.paused) await fallbackDecode(ctx); }, 1200);
        a.addEventListener('playing', ()=>{ clearTimeout(t); onSuccess(); }, { once:true });
      }

      function onSuccess(){
        const ov = document.getElementById('overlay');
        if (ov) ov.style.display = 'none';
        // ì•± ì „í™˜ í›„ ë³µê·€ ì‹œ ëŠê¸°ë©´ ì¬ì‹œë„
        document.addEventListener('visibilitychange', ()=>{
          if (!document.hidden && a.paused) { a.play().catch(()=>{}); }
        });
      }

      // ---- 4) ìµœí›„ í´ë°±: WebAudioë¡œ m4a ì§ì ‘ ë””ì½”ë”© í›„ ì¬ìƒ
      async function fallbackDecode(ctxInstance){
        // ì´ë¯¸ overlay ë¬¸êµ¬ ì—…ë°ì´íŠ¸
        const ov = document.getElementById('overlay');
        if (ov) ov.firstChild.textContent = 'ì¬ìƒ ì¤€ë¹„ì¤‘â€¦ (í´ë°± ì¤‘)';

        try {
          const resp = await fetch(FILE_URL, { cache: 'force-cache' });
          if (!resp.ok) throw new Error('HTTP '+resp.status);
          const arr = await resp.arrayBuffer();

          const buf = await new Promise((res, rej)=> {
            try { ctxInstance.decodeAudioData(arr, res, rej); }
            catch(e){ rej(e); }
          });

          const node = ctxInstance.createBufferSource();
          node.buffer = buf;
          node.connect(ctxInstance.destination);
          node.start(0);

          if (ov) ov.style.display = 'none';
        } catch(e) {
          // ê·¸ë˜ë„ ì‹¤íŒ¨ â†’ ì‚¬ìš©ì í™˜ê²½ ì´ìŠˆ (ë¬´ìŒ ìŠ¤ìœ„ì¹˜/ì‚¬ì´íŠ¸ ìŒì†Œê±° ë“±)
          if (ov) ov.firstChild.textContent = 'ì¬ìƒ ì‹¤íŒ¨ âŒ  (ë¬´ìŒ ìŠ¤ìœ„ì¹˜/ë³¼ë¥¨/ì‚¬ì´íŠ¸ ìŒì†Œê±° í™•ì¸ í›„ ë‹¤ì‹œ í„°ì¹˜)';
          started = false; // ì¬ì‹œë„ í—ˆìš©
          bindOnce();
        }
      }

    } catch(eOuter) {
      // AudioContextì¡°ì°¨ ì•ˆë˜ë©´ ë§ˆì§€ë§‰ ì•ˆë‚´
      const ov = document.getElementById('overlay');
      if (ov) ov.firstChild.textContent = 'ì¬ìƒ ì‹¤íŒ¨ âŒ  (ë¸Œë¼ìš°ì €/OS ì œí•œ)';
      started = false;
      bindOnce();
    }
  }

  bindOnce(); // ì´ˆê¸° ë°”ì¸ë”©
})();
</script>
</body>
</html>
